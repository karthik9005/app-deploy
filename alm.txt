/* One row per schema (OWNER) with size + object counts */
WITH seg AS (
  SELECT owner,
         SUM(bytes) / 1024 / 1024 AS total_mb,
         SUM(CASE WHEN segment_type LIKE 'TABLE%' THEN bytes ELSE 0 END) / 1024 / 1024 AS table_mb,
         SUM(CASE WHEN segment_type LIKE 'INDEX%' THEN bytes ELSE 0 END) / 1024 / 1024 AS index_mb,
         SUM(CASE WHEN segment_type LIKE 'LOB%' THEN bytes ELSE 0 END) / 1024 / 1024 AS lob_mb
  FROM dba_segments
  GROUP BY owner
),
obj AS (
  SELECT owner,
         COUNT(*) AS total_objects,
         SUM(CASE WHEN object_type = 'TABLE' THEN 1 ELSE 0 END) AS tables,
         SUM(CASE WHEN object_type = 'INDEX' THEN 1 ELSE 0 END) AS indexes,
         SUM(CASE WHEN object_type = 'VIEW' THEN 1 ELSE 0 END) AS views,
         MAX(last_ddl_time) AS last_ddl_time
  FROM dba_objects
  GROUP BY owner
),
tbl AS (
  SELECT owner,
         COUNT(*) AS table_count,
         SUM(num_rows) AS sum_num_rows,             -- depends on stats
         MAX(last_analyzed) AS last_analyzed
  FROM dba_tables
  GROUP BY owner
)
SELECT u.username                                   AS schema_name,
       u.created                                    AS user_created,
       u.account_status,
       u.default_tablespace,
       u.temporary_tablespace,
       NVL(o.total_objects, 0)                      AS total_objects,
       NVL(o.tables, 0)                             AS tables,
       NVL(o.indexes, 0)                            AS indexes,
       NVL(o.views, 0)                              AS views,
       NVL(t.table_count, 0)                        AS dba_tables_count,
       NVL(t.sum_num_rows, 0)                       AS sum_num_rows_from_stats,
       t.last_analyzed                              AS last_analyzed_any_table,
       o.last_ddl_time                              AS last_ddl_time_any_object,
       ROUND(NVL(s.total_mb, 0), 2)                 AS total_mb,
       ROUND(NVL(s.table_mb, 0), 2)                 AS table_mb,
       ROUND(NVL(s.index_mb, 0), 2)                 AS index_mb,
       ROUND(NVL(s.lob_mb, 0), 2)                   AS lob_mb
FROM dba_users u
LEFT JOIN seg s ON s.owner = u.username
LEFT JOIN obj o ON o.owner = u.username
LEFT JOIN tbl t ON t.owner = u.username
-- Optional: filter to ALM naming pattern (EDIT THIS)
-- WHERE u.username LIKE 'ALM_%' OR u.username LIKE 'TD_%'
ORDER BY total_mb DESC, schema_name;
